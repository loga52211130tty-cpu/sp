<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>智慧藥盒管理（完整版）</title>
<style>
body { font-family: Arial; }
table { border-collapse: collapse; width: 80%; margin-top:10px; }
th, td { border: 1px solid #333; padding: 8px; text-align: center; }
th { background-color: #eee; }
input[type="text"], input[type="time"] { width: 100%; }
button { padding: 4px 8px; }
tr.remind { background-color: #ffeb3b; animation: blink 1s infinite alternate; }
@keyframes blink { from {background-color: #fff176;} to {background-color: #fff;} }
.group-header { background-color: #ddd; cursor: pointer; }
.group-header:hover { background-color: #ccc; }
</style>
</head>
<body>

<h2>智慧藥盒管理</h2>

<!-- 新增藥品 -->
<div>
  <input type="text" id="newName" list="drugNames" placeholder="藥品名稱">
  <datalist id="drugNames"></datalist>
  <input type="text" id="newTimes" placeholder="時間（多個用逗號隔開，如08:00,12:00）">
  <button onclick="addDrug()">新增藥品</button>
</div>

<!-- 藥品表格 -->
<table id="drugTable">
  <thead>
    <tr>
      <th>#</th>
      <th>藥品名稱</th>
      <th>時間</th>
      <th>已服用</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const WEB_APP_URL = 'YOUR_WEB_APP_URL_HERE'; // ← 替換成你最新部署 Web App URL
let drugCache = [];

// 提醒音效
const audio = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");

// 請求瀏覽器通知權限
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

// 取得資料
function fetchDrugs() {
  fetch(WEB_APP_URL)
    .then(res => res.json())
    .then(json => {
      if(json.status !== "success") return;
      renderTable(json.data);
      updateDatalist(json.data);
      drugCache = json.data;
    });
}

// 渲染表格
function renderTable(data){
  const tbody = document.querySelector("#drugTable tbody");
  tbody.innerHTML = "";
  let groupMap = {};
  data.forEach(item => {
    if(!groupMap[item.name]) groupMap[item.name]=[];
    groupMap[item.name].push(item);
  });
  let idx=1;
  for(let name in groupMap){
    // 分組標題
    const header = document.createElement("tr");
    header.className="group-header";
    header.innerHTML=`<td colspan="5">${name}（點擊折疊/展開）</td>`;
    header.onclick = ()=>toggleGroup(name);
    tbody.appendChild(header);
    // 藥品列
    groupMap[name].forEach(item=>{
      const tr = document.createElement("tr");
      tr.dataset.rowIndex = item.rowIndex;
      tr.dataset.group = name;
      tr.innerHTML=`
        <td>${idx++}</td>
        <td>${item.name}</td>
        <td>${item.time}</td>
        <td><input type="checkbox" ${item.done?'checked':''} onchange="toggleDone(this,${item.rowIndex})"></td>
        <td><button onclick="deleteDrug(${item.rowIndex})">刪除</button></td>
      `;
      tbody.appendChild(tr);
    });
  }
}

// 更新 datalist（歷史藥品提示）
function updateDatalist(data){
  const dl = document.getElementById("drugNames");
  dl.innerHTML="";
  const names = [...new Set(data.map(d=>d.name))];
  names.forEach(n=>{
    const option = document.createElement("option");
    option.value = n;
    dl.appendChild(option);
  });
}

// 勾選已服用
function toggleDone(cb,rowIndex){
  const done=cb.checked;
  fetch(WEB_APP_URL,{
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({action:"update",data:[{rowIndex,done}]})
  }).then(res=>res.json()).then(result=>{
    if(result.status!=="success"){ alert("更新失敗"); cb.checked=!done; }
  });
}

// 新增藥品（可多時間）
function addDrug(){
  const name = document.getElementById("newName").value.trim();
  const times = document.getElementById("newTimes").value.trim().split(",");
  if(!name || times.length===0) return alert("請輸入名稱與時間");

  let promises = times.map(time =>
    fetch(WEB_APP_URL,{
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({action:"write",data:{name,time:time.trim(),done:false}})
    }).then(res=>res.json())
  );

  Promise.all(promises).then(results=>{
    let failed = results.filter(r=>r.status!=="success");
    if(failed.length>0) alert("有些藥品新增失敗");
    document.getElementById("newName").value="";
    document.getElementById("newTimes").value="";
    fetchDrugs();
  });
}

// 刪除藥品
function deleteDrug(rowIndex){
  if(!confirm("確定刪除此藥品？")) return;
  fetch(WEB_APP_URL,{
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({action:"delete",rowIndex})
  }).then(res=>res.json()).then(r=>{
    if(r.status==="success") fetchDrugs();
    else alert("刪除失敗");
  });
}

// 分組折疊
function toggleGroup(name){
  document.querySelectorAll(`tr[data-group="${name}"]`).forEach(tr=>{
    tr.style.display = (tr.style.display==="none")?"":"none";
  });
}

// 提醒高亮 + 音效 + 通知
function checkReminders(){
  const now = new Date();
  const nowTime = now.getHours()*60+now.getMinutes();
  document.querySelectorAll("#drugTable tbody tr").forEach(tr=>{
    if(!tr.dataset.rowIndex) return;
    const timeText = tr.children[2].textContent;
    if(!timeText) return;
    const [h,m] = timeText.split(":").map(Number);
    const target = h*60+m;
    const diff = target - nowTime;
    const checkbox = tr.querySelector("input[type=checkbox]");
    
    if(diff >= 0 && diff <= 5 && !checkbox.checked){
      tr.classList.add("remind");
      audio.play().catch(e=>console.log("播放音效失敗", e));
      if(Notification.permission === "granted"){
        const name = tr.children[1].textContent;
        const timeStr = tr.children[2].textContent;
        new Notification("智慧藥盒提醒", {
          body: `${timeStr} 要服用 ${name}`,
          icon: "https://img.icons8.com/color/48/000000/pill.png"
        });
      }
    } else tr.classList.remove("remind");
  });
}

// 初始化
fetchDrugs();
setInterval(fetchDrugs,10000);      // 每 10 秒刷新試算表
setInterval(checkReminders,10000);  // 每 10 秒檢查提醒
</script>

</body>
</html>
