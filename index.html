<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>智慧藥盒管理</title>
<style>
  table { border-collapse: collapse; width: 50%; }
  th, td { border: 1px solid #333; padding: 8px; text-align: center; }
  th { background-color: #eee; }
  input[type="text"], input[type="time"] { width: 100%; }
  button { padding: 4px 8px; }
</style>
</head>
<body>
<h2>智慧藥盒管理</h2>

<!-- 新增藥品區 -->
<div>
  <input type="text" id="newName" placeholder="藥品名稱">
  <input type="time" id="newTime">
  <button onclick="addDrug()">新增藥品</button>
</div>

<!-- 藥品列表 -->
<table id="drugTable">
  <thead>
    <tr>
      <th>#</th>
      <th>藥品名稱</th>
      <th>時間</th>
      <th>已服用</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwxOl74ue1pG5rHSSueIwP5gMrA05lgTmk9PN1vSRzAYkcHPKHyNvTLNeAij2kvnYrv/exec';

// 取得並顯示列表
function fetchDrugs() {
  fetch(WEB_APP_URL)
    .then(res => res.json())
    .then(json => {
      const tbody = document.querySelector("#drugTable tbody");
      tbody.innerHTML = "";
      json.data.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.rowIndex - 1}</td>
          <td>${item.name}</td>
          <td>${item.time}</td>
          <td><input type="checkbox" data-row-index="${item.rowIndex}" ${item.done ? 'checked' : ''} onchange="toggleDone(this)"></td>
        `;
        tbody.appendChild(tr);
      });
    });
}

// 勾選已服用
function toggleDone(cb) {
  const rowIndex = parseInt(cb.dataset.rowIndex);
  const done = cb.checked;
  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "update", data: [{ rowIndex, done }] })
  })
  .then(res => res.json())
  .then(result => {
    if(result.status !== "success") {
      alert("更新失敗");
      cb.checked = !done;
    }
  });
}

// 新增藥品
function addDrug() {
  const name = document.getElementById("newName").value.trim();
  const time = document.getElementById("newTime").value;
  if(!name || !time) { alert("請輸入藥品名稱與時間"); return; }

  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "write", data: { name, time, done: false } })
  })
  .then(res => res.json())
  .then(result => {
    if(result.status === "success") {
      document.getElementById("newName").value = "";
      document.getElementById("newTime").value = "";
      fetchDrugs();
    } else {
      alert("新增失敗：" + result.message);
    }
  });
}

// 初始化
fetchDrugs();
</script>
</body>
</html>
