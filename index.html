<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>智慧藥盒管理</title>
<style>
  body { font-family: "Microsoft JhengHei"; }
  table { border-collapse: collapse; width: 60%; margin-top: 10px; }
  th, td { border: 1px solid #333; padding: 8px; text-align: center; }
  th { background-color: #eee; }
  input[type="text"], input[type="time"] { width: 100%; box-sizing: border-box; }
  button { padding: 4px 8px; cursor: pointer; }
  .remind { background-color: #ffe9a7; animation: blink 1s infinite; }
  @keyframes blink {
    0%, 100% { background-color: #ffe9a7; }
    50% { background-color: #fff; }
  }
</style>
</head>
<body>
<h2>智慧藥盒管理</h2>

<!-- 新增藥品區 -->
<div>
  <input type="text" id="newName" placeholder="藥品名稱">
  <input type="time" id="newTime">
  <button onclick="addDrug()">新增藥品</button>
</div>

<!-- 藥品列表 -->
<table id="drugTable">
  <thead>
    <tr>
      <th>#</th>
      <th>藥品名稱</th>
      <th>時間</th>
      <th>已服用</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- 提醒區 -->
<div id="reminder" style="margin-top:10px; color:red; font-weight:bold;"></div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwxOl74ue1pG5rHSSueIwP5gMrA05lgTmk9PN1vSRzAYkcHPKHyNvTLNeAij2kvnYrv/exec';

let drugData = [];

// 取得並顯示列表
function fetchDrugs() {
  fetch(WEB_APP_URL)
    .then(res => res.json())
    .then(json => {
      drugData = json.data;
      renderTable();
    });
}

// 顯示表格
function renderTable() {
  const tbody = document.querySelector("#drugTable tbody");
  tbody.innerHTML = "";
  const now = new Date();
  const currentTime = now.getHours() * 60 + now.getMinutes();
  let reminderMsg = "";

  drugData.forEach(item => {
    const tr = document.createElement("tr");
    const [h, m] = item.time.split(":").map(Number);
    const drugTime = h * 60 + m;
    const diff = Math.abs(drugTime - currentTime);
    const isReminder = diff <= 5 && !item.done; // ±5分鐘提醒

    if (isReminder) {
      tr.classList.add("remind");
      reminderMsg += `⏰ ${item.name} 即將在 ${item.time} 服用！<br>`;
    }

    tr.innerHTML = `
      <td>${item.rowIndex - 1}</td>
      <td>${item.name}</td>
      <td>${item.time}</td>
      <td><input type="checkbox" data-row-index="${item.rowIndex}" ${item.done ? 'checked' : ''} onchange="toggleDone(this)"></td>
      <td><button onclick="deleteDrug(${item.rowIndex})">刪除</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("reminder").innerHTML = reminderMsg || "";
}

// 勾選已服用
function toggleDone(cb) {
  const rowIndex = parseInt(cb.dataset.rowIndex);
  const done = cb.checked;
  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "update", data: [{ rowIndex, done }] })
  })
  .then(res => res.json())
  .then(result => {
    if(result.status !== "success") {
      alert("更新失敗");
      cb.checked = !done;
    } else {
      fetchDrugs();
    }
  });
}

// 新增藥品
function addDrug() {
  const name = document.getElementById("newName").value.trim();
  const time = document.getElementById("newTime").value;
  if(!name || !time) { alert("請輸入藥品名稱與時間"); return; }

  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "write", data: { name, time, done: false } })
  })
  .then(res => res.json())
  .then(result => {
    if(result.status === "success") {
      document.getElementById("newName").value = "";
      document.getElementById("newTime").value = "";
      fetchDrugs();
    } else {
      alert("新增失敗：" + result.message);
    }
  });
}

// 刪除藥品
function deleteDrug(rowIndex) {
  if(!confirm("確定要刪除此藥品嗎？")) return;
  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "delete", data: { rowIndex } })
  })
  .then(res => res.json())
  .then(result => {
    if(result.status === "success") {
      fetchDrugs();
    } else {
      alert("刪除失敗：" + result.message);
    }
  });
}

// 自動刷新與提醒檢查
setInterval(fetchDrugs, 60000); // 每分鐘更新
setInterval(() => renderTable(), 30000); // 每30秒重畫提醒狀態

// 初始化
fetchDrugs();
</script>
</body>
</html>
