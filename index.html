<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>智慧藥盒</title>
<style>
body { font-family:'微軟正黑體'; padding:20px; background:#f5f5f5; }
h1 { color:#2c3e50; }
table { border-collapse:collapse; width:100%; background:white; }
th,td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#3498db; color:white; }
button { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
input { padding:5px; margin:4px; }
</style>
</head>
<body>

<h1>智慧藥盒</h1>
<div>目前時間：<span id="nowTime"></span></div>

<div>
  藥品名稱：<input id="drugName" list="drugHistory">
  <datalist id="drugHistory"></datalist>
  時間(多個可逗號)：<input id="drugTime" placeholder="08:00,12:00">
  <button onclick="addDrug()">新增藥品</button>
</div>

<table id="drugTable">
<tr><th>#</th><th>藥品名稱</th><th>時間</th><th>已服用</th><th>操作</th></tr>
</table>

<script>
const WEB_APP_URL = window.location.href;

// 時鐘
function updateClock(){
  const now=new Date();
  document.getElementById('nowTime').innerText=now.toLocaleTimeString('zh-TW',{hour12:false});
}
setInterval(updateClock,1000);
updateClock();

// 載入資料
async function loadData(){
  const res = await fetch(WEB_APP_URL + "?action=read");
  const data = await res.json();
  const tbody = document.getElementById('drugTable');
  tbody.innerHTML='<tr><th>#</th><th>藥品名稱</th><th>時間</th><th>已服用</th><th>操作</th></tr>';

  // 歷史藥品名稱下拉
  const dl = document.getElementById('drugHistory');
  dl.innerHTML='';
  [...new Set(data.map(d=>d.name))].forEach(n=>{
    const opt=document.createElement('option'); opt.value=n; dl.appendChild(opt);
  });

  data.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${r.name}</td>
      <td>${r.time}</td>
      <td><input type="checkbox" ${r.done==='TRUE'?'checked':''} onchange="toggleDone(${i+2},this.checked)"></td>
      <td><button onclick="deleteDrug(${i+2})">刪除</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// 新增藥品
async function addDrug(){
  const name=document.getElementById('drugName').value.trim();
  const time=document.getElementById('drugTime').value.trim();
  if(!name||!time) return alert('請輸入藥品名稱與時間');

  await fetch(WEB_APP_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action:'add',name,time})
  });
  document.getElementById('drugName').value='';
  document.getElementById('drugTime').value='';
  loadData();
}

// 勾選已服用
async function toggleDone(row,checked){
  await fetch(WEB_APP_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action:'done',row})
  });
  loadData();
}

// 刪除藥品
async function deleteDrug(row){
  if(!confirm('確定刪除?')) return;
  await fetch(WEB_APP_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action:'delete',row})
  });
  loadData();
}

loadData();
setInterval(loadData,10000); // 每10秒刷新一次
</script>

</body>
</html>
