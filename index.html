<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>智慧藥盒管理</title>
  <style>
    table {
      border-collapse: collapse;
      width: 60%;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #333;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    select, input[type="text"], input[type="time"] {
      width: 100%;
    }
    button {
      padding: 4px 8px;
    }
  </style>
</head>
<body>
  <h2>智慧藥盒管理</h2>

  <!-- 新增藥品區 -->
  <div>
    <select id="drugSelect">
      <option value="">-- 選擇歷史藥品 --</option>
    </select>
    <input type="text" id="newName" placeholder="或輸入新藥品名稱">
    <input type="time" id="newTime">
    <button onclick="addDrug()">新增藥品</button>
  </div>

  <!-- 目前藥品清單 -->
  <h3>目前藥品列表</h3>
  <table id="drugTable">
    <thead>
      <tr>
        <th>#</th>
        <th>藥品名稱</th>
        <th>時間</th>
        <th>已服用</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwxOl74ue1pG5rHSSueIwP5gMrA05lgTmk9PN1vSRzAYkcHPKHyNvTLNeAij2kvnYrv/exec';

    // 取得藥品清單
    function fetchDrugs() {
      fetch(WEB_APP_URL)
        .then(res => res.json())
        .then(json => {
          const tbody = document.querySelector("#drugTable tbody");
          tbody.innerHTML = "";
          json.data.forEach((item, idx) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${idx + 1}</td>
              <td>${item.name}</td>
              <td>${item.time}</td>
              <td>
                <input type="checkbox" data-row-index="${item.rowIndex}" ${item.done ? 'checked' : ''} onchange="toggleDone(this)">
              </td>
              <td>
                <button onclick="deleteDrug(${item.rowIndex})">刪除</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
    }

    // 勾選已服用
    function toggleDone(cb) {
      const rowIndex = parseInt(cb.dataset.rowIndex);
      const done = cb.checked;
      fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "update",
          data: [{ rowIndex, done }]
        })
      })
      .then(res => res.json())
      .then(result => {
        if (result.status !== "success") {
          alert("更新失敗");
          cb.checked = !done;
        }
      });
    }

    // 刪除藥品
    function deleteDrug(rowIndex) {
      if (!confirm("確定要刪除這個藥品嗎？")) return;

      fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "delete",
          data: { rowIndex }
        })
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === "success") {
          fetchDrugs();
          fetchHistoryList();
        } else {
          alert("刪除失敗：" + result.message);
        }
      });
    }

    // 新增藥品
    function addDrug() {
      const selected = document.getElementById("drugSelect").value;
      const manual = document.getElementById("newName").value.trim();
      const name = manual || selected;
      const time = document.getElementById("newTime").value;

      if (!name || !time) {
        alert("請輸入藥品名稱與時間");
        return;
      }

      fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "write",
          data: { name, time, done: false }
        })
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === "success") {
          document.getElementById("newName").value = "";
          document.getElementById("newTime").value = "";
          fetchDrugs();
          fetchHistoryList();
        } else {
          alert("新增失敗：" + result.message);
        }
      });
    }

    // 取得歷史藥品列表
    function fetchHistoryList() {
      fetch(WEB_APP_URL + '?mode=history')
        .then(res => res.json())
        .then(json => {
          const select = document.getElementById("drugSelect");
          select.innerHTML = '<option value="">-- 選擇歷史藥品 --</option>';
          json.history.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
          });
        });
    }

    // 初始化
    fetchDrugs();
    fetchHistoryList();
  </script>
</body>
</html>
