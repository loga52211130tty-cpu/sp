<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ™ºæ…§è—¥ç›’ç®¡ç†</title>
<style>
  table { border-collapse: collapse; width: 60%; }
  th, td { border: 1px solid #333; padding: 8px; text-align: center; }
  th { background-color: #eee; }
  input[type="text"], input[type="time"] { width: 100%; }
  button { padding: 4px 8px; }
  tr.alert { background-color: #ffdddd; animation: blink 1s infinite alternate; }
  @keyframes blink { from { background-color: #ffcccc; } to { background-color: #ffffff; } }
</style>
</head>
<body>
<h2>æ™ºæ…§è—¥ç›’ç®¡ç†</h2>

<div>
  <input type="text" id="newName" placeholder="è—¥å“åç¨±">
  <input type="time" id="newTime">
  <button onclick="addDrug()">æ–°å¢è—¥å“</button>
</div>

<table id="drugTable">
  <thead>
    <tr>
      <th>#</th>
      <th>è—¥å“åç¨±</th>
      <th>æ™‚é–“</th>
      <th>å·²æœç”¨</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<audio id="alertSound" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwxOl74ue1pG5rHSSueIwP5gMrA05lgTmk9PN1vSRzAYkcHPKHyNvTLNeAij2kvnYrv/exec';
let drugData = [];           // æš«å­˜è—¥å“è³‡æ–™
let alertedList = new Set(); // å·²æé†’éçš„è—¥å“

// å–å¾—è³‡æ–™ï¼ˆå®Œæ•´æ›´æ–°ï¼‰
function fetchDrugs() {
  fetch(WEB_APP_URL)
    .then(res => res.json())
    .then(json => {
      if (json.status === "success") {
        drugData = json.data;
        renderTable();
      }
    });
}

// é¡¯ç¤ºè³‡æ–™è¡¨
function renderTable() {
  const tbody = document.querySelector("#drugTable tbody");
  tbody.innerHTML = "";
  drugData.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.rowIndex - 1}</td>
      <td>${item.name}</td>
      <td>${item.time}</td>
      <td><input type="checkbox" data-row-index="${item.rowIndex}" ${item.done ? 'checked' : ''} onchange="toggleDone(this)"></td>
      <td><button onclick="deleteDrug(${item.rowIndex})">åˆªé™¤</button></td>
    `;
    tbody.appendChild(tr);
  });
  checkReminders(); // åˆæ¬¡æ¸²æŸ“æ™‚æª¢æŸ¥æé†’
}

// æª¢æŸ¥æ˜¯å¦éœ€æé†’ï¼ˆä¸é‡æ–°ä¸‹è¼‰ï¼‰
function checkReminders() {
  const now = new Date();
  const nowMins = now.getHours() * 60 + now.getMinutes();
  const tbody = document.querySelector("#drugTable tbody");
  const rows = tbody.querySelectorAll("tr");

  drugData.forEach((item, idx) => {
    const [h, m] = item.time.split(":").map(Number);
    const targetMins = h * 60 + m;
    const diff = Math.abs(nowMins - targetMins);
    const tr = rows[idx];
    
    if (diff <= 5 && !item.done) {
      tr.classList.add("alert");
      if (!alertedList.has(item.rowIndex)) {
        playAlert();
        alertedList.add(item.rowIndex);
      }
    } else {
      tr.classList.remove("alert");
      alertedList.delete(item.rowIndex);
    }
  });
}

// æ’­æ”¾æç¤ºéŸ³
function playAlert() {
  const sound = document.getElementById("alertSound");
  sound.currentTime = 0;
  sound.play().catch(()=>{});
}

// æ–°å¢è—¥å“
function addDrug() {
  const name = document.getElementById("newName").value.trim();
  const time = document.getElementById("newTime").value;
  if (!name || !time) { alert("è«‹è¼¸å…¥è—¥å“åç¨±èˆ‡æ™‚é–“"); return; }

  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "write", data: { name, time, done: false } })
  })
  .then(res => res.json())
  .then(result => {
    if (result.status === "success") {
      document.getElementById("newName").value = "";
      document.getElementById("newTime").value = "";
      fetchDrugs();
    } else {
      alert("æ–°å¢å¤±æ•—ï¼š" + result.message);
    }
  });
}

// å‹¾é¸å·²æœç”¨
function toggleDone(cb) {
  const rowIndex = parseInt(cb.dataset.rowIndex);
  const done = cb.checked;
  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "update", data: [{ rowIndex, done }] })
  })
  .then(res => res.json())
  .then(result => {
    if (result.status !== "success") {
      alert("æ›´æ–°å¤±æ•—");
      cb.checked = !done;
    } else {
      drugData.find(d => d.rowIndex === rowIndex).done = done;
      checkReminders(); // ç«‹å³æ›´æ–°æé†’ç‹€æ…‹
    }
  });
}

// åˆªé™¤è—¥å“
function deleteDrug(rowIndex) {
  if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è—¥å“å—ï¼Ÿ")) return;
  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "delete", rowIndex })
  })
  .then(res => res.json())
  .then(result => {
    if (result.status === "success") {
      fetchDrugs();
    } else {
      alert("åˆªé™¤å¤±æ•—ï¼š" + result.message);
    }
  });
}

// åˆå§‹åŒ–
fetchDrugs();
setInterval(checkReminders, 10000); // ğŸ” æ¯10ç§’æª¢æŸ¥æé†’ï¼ˆä¸é‡æ–°è¼‰å…¥ï¼‰
setInterval(fetchDrugs, 60000);     // æ¯1åˆ†é˜æ›´æ–°è³‡æ–™
</script>
</body>
</html>
